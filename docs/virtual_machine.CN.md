# Xue语言虚拟机设计文档

[English](./virtual_machine.md) | **简体中文**

本文档描述了Xue语言虚拟机设计的每个细节部分。

## 虚拟机结构

虚拟机可分为三部分，数据存储区、指令存储区以及堆栈数据区。

其中数据存储区又分为常量池和全局变量区。常量池主要用来存储字符串常量以及外部函数索引。而全局变量区则存储着所有在本字节码文件中将被使用的全局变量。其中，常量池的所有数据都是只读数据，而全局变量区的数据则可以被修改。

当虚拟机加载字节码文件后，所有的指令都会被存放在指令存储区，这块内存区域同样也不能写入，初始化后只能被读取。

唯一能被自由读写的数据区域是堆栈数据区，堆栈区可以访问从0下标开始，一直到偏移量为栈大小-1的位置。默认情况下，虚拟机将会为堆栈区分配1MB的内存，用户编译得到的字节码文件可以自由地操纵这块区域的任何数据。

## 输入数据

虚拟机目前支持输入字节码文件路径然后执行。未来可能支持代码创建虚拟机，通过传入字节数组。

## 虚拟机状态一览

Xue语言的虚拟机的执行过程可以理解为是一个有穷状态机。其总共有四个状态，初始化、验证、执行和释放资源。

当虚拟机未加载字节码文件之前，会先给堆栈数据区分配内存，并初始化堆栈指针，基址指针等内部变量。

随后，虚拟机会读入通过调用传入的参数，开始加载字节码文件，并转为验证状态。

执行指令之前，虚拟机必须保证输入文件的格式符合定义，因此会依次检测文件标识、版本号等元信息。通过校验后才会转入执行状态。

在执行第一条指令之前，虚拟机需要先读入字节码文件的头信息里面的常量池数据、全局变量数据。需要先开辟这两部分数据的内存空间，并将这些数据加载到内存中。然后才会开始读取并执行指令。当虚拟机执行完最后一条指令，就意味着整个程序执行完毕，将会转入资源释放状态。

在释放阶段，虚拟机首先会释放指令数据区的内存，然后依次是全局数据区和常量池。最后结束程序。

如果执行过程中出现了异常，虚拟机进程将会返回1，如果正常执行结束，则返回0.

## C语言描述下的虚拟机结构

```c
typedef Instruction unsigned int;
typedef Byte unsigned char;
typedef u32 unsigned int;
struct Xue_VM {
  Instruction* program_counter;
  Byte* stack_pointer;

  Instruction* instructions;
  u32 instruction_count;

  Byte* constant_data;
  u32 constant_data_size;

  Global_Variable* global_variables;
  u32 global_variables_count;

  Byte* the_stack;
};
```
